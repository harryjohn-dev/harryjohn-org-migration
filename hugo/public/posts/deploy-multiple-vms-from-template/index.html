<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Deploy multiple VMs from template with PowerCLI | Harry John</title>
<meta name="keywords" content="powercli, vmware, powershell, automation, deployment, citrix, xenapp, xendesktop">
<meta name="description" content="
I frequently need to deploy multiple VMs from a template in large numbers, most often a bunch of Citrix XenApp or XenDesktop servers following an update to the gold image. Without an automated method deployment can become a headache and would take days to deploy multiple VMs, especially when taking into account the post-deploy tasks such as activating Windows, activating Office, installing Citrix, putting the computer into the right OU etc.">
<meta name="author" content="Harry John">
<link rel="canonical" href="http://localhost:1313/posts/deploy-multiple-vms-from-template/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css" integrity="sha256-j&#43;ECM6cGvIfy4Is8&#43;XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/deploy-multiple-vms-from-template/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Harry John (Alt + H)">Harry John</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Deploy multiple VMs from template with PowerCLI
    </h1>
    <div class="post-meta"><span title='2014-01-06 00:00:00 +0000 UTC'>January 6, 2014</span>&nbsp;·&nbsp;12 min&nbsp;·&nbsp;2387 words&nbsp;·&nbsp;Harry John

</div>
  </header> 
  <div class="post-content"><p><img alt="Deploy multiple VMs from template" loading="lazy" src="/images/deploy-multiple-vms-from-template-300x211.png"></p>
<p>I frequently need to deploy multiple VMs from a template in large numbers, most often a bunch of Citrix XenApp or XenDesktop servers following an update to the gold image. Without an automated method deployment can become a headache and would take days to deploy multiple VMs, especially when taking into account the post-deploy tasks such as activating Windows, activating Office, installing Citrix, putting the computer into the right OU etc.</p>
<p>Rather than consuming large amounts of paracetamol I have written a (fairly long) PowerCLI script to remove as many of the manual and mundane tasks as I could. In this blog post I am going to run through the script and explain how it works. You may download the complete script and use it “out-the-box” or make your own modifications, otherwise read on to understand how I deploy multiple VMs from template using PowerCLI.</p>
<p>The script currently does the following:</p>
<ul>
<li>Deploys multiple VMs from template</li>
<li>Chooses the best datastores to deploy multiple VMs based on capacity and number of VMs/datastore</li>
<li>Powers on the VM</li>
<li>Puts the VM in the correct OU within AD</li>
<li>Activates Windows</li>
<li>Activates Office</li>
<li>Changes IP address</li>
<li>Starts a custom service (I used this to start IMA service which adds the VM to Citrix AppCenter)</li>
</ul>
<p>The complete script is currently approximately 700 lines in total and you can <a href="http://www.harryjohn.org/wp-content/uploads/2014/01/DeployMultipleVMs1.zip">download the complete script</a>, however for the educational purpose of this article I will just go through some major snippets. Hopefully this will help give you some ideas or to understand the basics of how this works.</p>
<p>In this blog post I will cover the following aspects of the script:</p>
<ul>
<li>How to deploy multiple VMs from template simultaneously</li>
<li>Keeping track of VMs as they go through the build process</li>
<li>Changing the IP address of a VM once deployed</li>
</ul>
<h2 id="deploy-multiple-vms-from-template-simultaneously">Deploy multiple VMs from template simultaneously<a hidden class="anchor" aria-hidden="true" href="#deploy-multiple-vms-from-template-simultaneously">#</a></h2>
<p>To deploy multiple VMs from template simultaneously I make use of <a href="http://blogs.technet.com/b/heyscriptingguy/archive/2012/12/31/using-windows-powershell-jobs.aspx">PowerShell Jobs</a>. For a complete understanding of how this works read through ScriptingGuy&rsquo;s excellent blog post. I will be using just two of these commands; Start-Job and Get-Job</p>
<p>Now, when invoking the Start-Job command a new hidden PowerShell instance will be launched in the background and runs the job within here. There are a few things to note;</p>
<ol>
<li>A new PowerCLI instance means a new session to vCenter, you will need to forward the current session to each instance/job you start</li>
<li>If you have a PowerShell profile script, this script will run for each instance/job you start</li>
</ol>
<p>I am not going to cover <a href="http://velemental.com/2012/03/11/multithreading-powercli/">Multi-threading PowerCLI</a> as this has been explained very well on the vElemental blog, I suggest you check it out for a full understanding of how this works. For now just know that I will be using two .ps1 files &ndash; the &ldquo;deploy VM script&rdquo; which will be invoked by what I like to call the &ldquo;control script&rdquo;, every time we want to deploy another VM simultaneously.</p>
<h2 id="the-deploy-vm-script">The deploy VM script<a hidden class="anchor" aria-hidden="true" href="#the-deploy-vm-script">#</a></h2>
<p>This script is simple. Other than the bit of work required in passing the vCenter session credentials over from the &ldquo;control script&rdquo;, all we need to do here is create a mini PowerCLI script to deploy one VM. So first, lets gather some parameters about the VM we are to deploy:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#66d9ef">Param</span> (
</span></span><span style="display:flex;"><span>    $session = $(<span style="color:#66d9ef">throw</span> <span style="color:#e6db74">&#34;missing -session parameter&#34;</span>),
</span></span><span style="display:flex;"><span>    $vcserver,
</span></span><span style="display:flex;"><span>    $name,
</span></span><span style="display:flex;"><span>    $datastore,
</span></span><span style="display:flex;"><span>    $ipaddr,
</span></span><span style="display:flex;"><span>    $template,
</span></span><span style="display:flex;"><span>    $folderName
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>There are just a few more parameters I will need, the host/cluster I am to deploy to, the customisation spec and the true VMware folder location:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">#========================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># PARAMETERS</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#========================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># host/cluster</span>
</span></span><span style="display:flex;"><span>$vmhost = <span style="color:#e6db74">&#34;cluster1&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># customisation spec</span>
</span></span><span style="display:flex;"><span>$custSpecName = <span style="color:#e6db74">&#34;W2K8-R2-X64&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># location</span>
</span></span><span style="display:flex;"><span>$folder = Get-Folder -Location <span style="color:#e6db74">&#34;Virtual Machines&#34;</span> -Name $folderName
</span></span></code></pre></div><p>There is something important to note about customisation specs. I have set my customisation spec to use DHCP and I will be applying a static IP once the VM has deployed, powered on and been customised. One method many people have discussed is to clone your main customisation spec into a new “temporary spec”, add the IP address details into this temporary spec and delete after you have deployed a VM with it. I just didn’t get along with this method. It would be nice if there was a way we could supply the details within PowerCLI for which you are prompted for when using the vSphere Client, as far as I know this is not possible.</p>
<p>Finally, we need the command to deploy a VM using the parameters we have collected above.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>$vm = New-VM -Name $name `
</span></span><span style="display:flex;"><span>	-VMHost $vmhost `
</span></span><span style="display:flex;"><span>	-Template $template `
</span></span><span style="display:flex;"><span>	-OSCustomizationSpec $custSpec `
</span></span><span style="display:flex;"><span>	-Datastore $datastore `
</span></span><span style="display:flex;"><span>	-Location $folder `
</span></span><span style="display:flex;"><span>	-ErrorAction:Stop
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">catch</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#75715e"># your catch method....</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>That’s it for the deploy VM script, I told you it was simple!</p>
<h2 id="the-control-script">The control script<a hidden class="anchor" aria-hidden="true" href="#the-control-script">#</a></h2>
<p>Getting slightly more complicated, the control script is the “brain” of the process and, you guessed it, controls the deployment of multiple VMs as well as completing any other post-deployment tasks. Lets just cover the basics.</p>
<p>First we must gather some information about the VMs we are to deploy. Some information I like to “hard code” in parameters at the top of the script such as the template name, DNS servers and gateway address. Other information I like to collect interactively when at run-time such as VM names, IP addresses, number of VMs. Here is an example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># HARD CODED PARAMETERS</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># vm settings</span>
</span></span><span style="display:flex;"><span>$folder = <span style="color:#e6db74">&#34;Citrix-NG Servers&#34;</span>
</span></span><span style="display:flex;"><span>$template = <span style="color:#e6db74">&#39;Citrix XenApp 6.5 Farm Member Template (Citrix Installed)&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># network variables</span>
</span></span><span style="display:flex;"><span>$networkSubnet = <span style="color:#e6db74">&#34;255.255.0.0&#34;</span>
</span></span><span style="display:flex;"><span>$networkGateway = <span style="color:#e6db74">&#34;172.16.0.1&#34;</span>
</span></span><span style="display:flex;"><span>$networkDns = <span style="color:#e6db74">&#34;172.16.0.2&#34;</span>,<span style="color:#e6db74">&#34;172.16.0.3&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># GATHER FROM USER PARAMETERS</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># get VM name prefix</span>
</span></span><span style="display:flex;"><span>$vmFirstName = Read-Host <span style="color:#e6db74">&#34;Enter the name of the first VM (e.g. MAILSERVER01)&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># get number of VMs to build</span>
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">int</span>]$vmQuantity = Read-Host <span style="color:#e6db74">&#34;How many VMs are you deploying?&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># get IP Address </span>
</span></span><span style="display:flex;"><span>$ipAddress = Read-Host <span style="color:#e6db74">&#34;You need a block of </span>$vmQuantity<span style="color:#e6db74"> adjacent IP addresses, enter the first&#34;</span>
</span></span></code></pre></div><p>You might have already noticed, when I deploy multiple VMs they will have the same name but a different number at the end, for example; MAILSERVER01, MAILSERVER02 etc. I also deploy VMs with a sequence of adjacent IP addresses for example; 172.16.0.101, 172.16.0.102 etc. This makes deployment and this script very simple because all I need to know is the first VM name, the first IP address, and how many VMs to deploy. From this information I can create a nice PowerShell array with each VM name and its IP address. Lets split up the first IP address we have collected to do this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># split up IP address</span>
</span></span><span style="display:flex;"><span>$ipSplit = $ipAddress.Split(<span style="color:#e6db74">&#34;.&#34;</span>)
</span></span><span style="display:flex;"><span>$ipPrefix = $ipSplit[<span style="color:#ae81ff">0</span>] + <span style="color:#e6db74">&#34;.&#34;</span> + $ipSplit[<span style="color:#ae81ff">1</span>] + <span style="color:#e6db74">&#34;.&#34;</span> + $ipSplit[<span style="color:#ae81ff">2</span>] + <span style="color:#e6db74">&#34;.&#34;</span> 
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">int</span>]$ipSuffix = $ipSplit[<span style="color:#ae81ff">3</span>]
</span></span></code></pre></div><p>Now I have the IP address prefix, such as 172.16.0 and the first IP address suffix, such as 101. If I put together the prefix and the suffix I get the complete IP address: 172.16.0.101. I can add one to the suffix, put them together again and have the IP address of the next VM: 172.16.0.102. Simples!</p>
<p>Again, I need to do this with the VM name, so take the last two characters of the name and you have the first VM number (suffix), take the other characters and you have the VM name (prefix):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># split up VM name</span>
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">int</span>]$vmFirstNumber = $vmFirstName.Substring($vmFirstName.length - <span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>$vmNamePrefix = $vmFirstName.Substring(<span style="color:#ae81ff">0</span>,$vmFirstName.length - <span style="color:#ae81ff">2</span>)
</span></span></code></pre></div><h2 id="keeping-track-of-vms-as-they-go-through-the-build-process">Keeping track of VMs as they go through the build process<a hidden class="anchor" aria-hidden="true" href="#keeping-track-of-vms-as-they-go-through-the-build-process">#</a></h2>
<p>Now we have collected all the info we need to deploy multiple VMs, I like to create an array which will keep track of the VMs, tasks and their status. So lets create a loop to build the VM name and the IP address using the prefixes and suffixes we created earlier and add each one to the array. I also add a few other properties for each VM to keep track of the build status, such as Clone Initiated, Cloned, Powered On and Re-IP.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">###################</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Build $vmStatus array to keep track of VMs and completed tasks</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">###################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># create an object collection holding status info for all VMs being built</span>
</span></span><span style="display:flex;"><span>$vmStatus = @()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># create counters for VM name and IP address/datastore</span>
</span></span><span style="display:flex;"><span>$vmNumber = $vmFirstNumber
</span></span><span style="display:flex;"><span>$vmCounter = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>..$vmQuantity | <span style="color:#66d9ef">foreach</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># if VM number is less than 10 add a 0 onto the server name so we dont have MAILSERVER1 for example</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> ($vmNumber <span style="color:#f92672">-lt</span> <span style="color:#ae81ff">10</span>) {
</span></span><span style="display:flex;"><span>		$vmName = $vmNamePrefix + <span style="color:#e6db74">&#34;0&#34;</span> + $vmNumber
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		$vmName = $vmNamePrefix + $vmNumber
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># compile IP address</span>
</span></span><span style="display:flex;"><span>        $vmIpAddress = $ipPrefix + ($ipSuffix + ($vmCounter))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># setup object properties</span>
</span></span><span style="display:flex;"><span>	$properties = [<span style="color:#66d9ef">ordered</span>]@{
</span></span><span style="display:flex;"><span>		MachineName = $vmName
</span></span><span style="display:flex;"><span>		IpAddress = $vmIpAddress
</span></span><span style="display:flex;"><span>		CloneInitiated = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		Cloned = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		PoweredOn = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		ReIP = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># create object and add to collection</span>
</span></span><span style="display:flex;"><span>	$obj = New-Object -TypeName PSObject -Property $properties
</span></span><span style="display:flex;"><span>	$vmStatus += $obj
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># increase counters</span>
</span></span><span style="display:flex;"><span>	$vmNumber++
</span></span><span style="display:flex;"><span>	$vmCounter++
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This is a good start, we now have a list of VMs, their IP addresses and the status of deployment. You could modify the above to perhaps import a list from CSV, rather than ask for the VM details interactively. A good reason to do this would be if you wanted to deploy multiple VMs without following my naming convention or adjacent IP addresses.</p>
<p>Prepare the command to deploy a VM using the deploy VM script we created earlier. I also clear the current job list in case any are still in memory from a previous time I ran the script without reloading my PowerShell session:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">###################</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Prepare to start deploying VMs</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">###################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># prepare VM deploy job command</span>
</span></span><span style="display:flex;"><span>$job= {
</span></span><span style="display:flex;"><span>	Set-Location $args[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>	powershell -command <span style="color:#e6db74">&#34;.\DeployVM.ps1 -session </span>$($args[<span style="color:#ae81ff">1</span>])<span style="color:#e6db74"> -vcserver </span>$($args[<span style="color:#ae81ff">2</span>])<span style="color:#e6db74"> -name </span>$($args[<span style="color:#ae81ff">3</span>])<span style="color:#e6db74"> -datastore </span>$($args[<span style="color:#ae81ff">4</span>])<span style="color:#e6db74"> -ipaddr </span>$($args[<span style="color:#ae81ff">5</span>])<span style="color:#e6db74"> -template </span><span style="color:#ae81ff">`&#39;</span>$($args[<span style="color:#ae81ff">6</span>])<span style="color:#ae81ff">`&#39;</span><span style="color:#e6db74"> -folder </span><span style="color:#ae81ff">`&#39;</span>$($args[<span style="color:#ae81ff">7</span>])<span style="color:#ae81ff">`&#39;</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># clear job list</span>
</span></span><span style="display:flex;"><span>Get-Job | Remove-Job
</span></span></code></pre></div><p>Time to start deploying multiple VMs! The following loop will continue looping until all tasks have been completed, that is all the properties for each VM within $vmStatus have a value of 1. Notice in the next few examples before each task I select the VMs which have not yet had that task completed and where previous tasks have been completed using a where query on $vmStatus. If the task then completes successfully, I set that property to 1.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#66d9ef">while</span> ($vmsCompleted.Count <span style="color:#f92672">-lt</span> $vmQuantity) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">###################</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># Initiate VM cloning, using $maxConcurrentJobs as the limit</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">###################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># do not start job if $maxConcurrentJobs are already running, do not start if all VMs are now cloned (clone initiated) - skip this task</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (($vmsCloneInitiated.Count <span style="color:#f92672">-lt</span> $vmQuantity) <span style="color:#f92672">-and</span> ($runningJobCount <span style="color:#f92672">-lt</span> $maxConcurrentJobs)) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># select VMs which have not yet been cloned - and only the first $maxConcurrentJobs VMs</span>
</span></span><span style="display:flex;"><span>        $vmStatus | where {($_.Cloned <span style="color:#f92672">-eq</span> <span style="color:#ae81ff">0</span>)} | Select-Object -first $maxConcurrentJobs | <span style="color:#66d9ef">foreach</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		    <span style="color:#75715e"># create job</span>
</span></span><span style="display:flex;"><span>		    Start-Job -Name $_.MachineName -ScriptBlock $job -ArgumentList $currentPath, $session, $vcserver, $_.MachineName, $_.Datastore, $_.IpAddress, $template, $folder		
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		    <span style="color:#75715e"># update vmStatus object collection</span>
</span></span><span style="display:flex;"><span>		    $_.CloneInitiated = <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><p>There are a few variables in the above example I have not yet mentioned, such as $vmsComplete.Count, $vmsCloneInitiated.Count and $runningJobCount. Lets update these</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>	<span style="color:#75715e">###################</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># Check running job count and look for VMs which have finished cloning</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">###################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># count current running jobs</span>
</span></span><span style="display:flex;"><span>	$jobs = Get-Job 
</span></span><span style="display:flex;"><span>	$runningJobs = $jobs | ? { $_.state <span style="color:#f92672">-eq</span> <span style="color:#e6db74">&#34;Running&#34;</span> }
</span></span><span style="display:flex;"><span>	$runningJobCount = $runningJobs.count
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># check for vms which have finished cloning</span>
</span></span><span style="display:flex;"><span>	$completedJobs = $jobs | ? { $_.state <span style="color:#f92672">-eq</span> <span style="color:#e6db74">&#34;Completed&#34;</span> }	
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># update $vmStatus</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">foreach</span> ($completedJob <span style="color:#66d9ef">in</span> $completedJobs) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># get index of object and set cloned to 1</span>
</span></span><span style="display:flex;"><span>		$vmStatusIndex = <span style="color:#ae81ff">0</span>..($vmStatus.Count <span style="color:#ae81ff">-1</span>) | where {$vmStatus[$_].MachineName <span style="color:#f92672">-eq</span> $completedJob.Name}
</span></span><span style="display:flex;"><span>		$vmStatus[$vmStatusIndex].Cloned = <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><p>Finally, the rest of the loop to complete the remaining tasks. I have stripped out much of the code within each task to keep this looking simple for the purpose of the article.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>	<span style="color:#75715e">###################</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># Power on VMs which have finished cloning</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">###################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	$vmStatus | where {($_.Cloned <span style="color:#f92672">-ne</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">-and</span> ($_.PoweredOn <span style="color:#f92672">-eq</span> <span style="color:#ae81ff">0</span>)} | <span style="color:#66d9ef">foreach</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># start the VM</span>
</span></span><span style="display:flex;"><span>		Start-VM $_.MachineName
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># update $vmStatus</span>
</span></span><span style="display:flex;"><span>		$_.PoweredOn = <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	}	
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">###################</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># Set correct IP address for VMs and start Citrix service</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">###################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	$vmStatus | where {($_.Cloned <span style="color:#f92672">-ne</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">-and</span> ($_.PoweredOn <span style="color:#f92672">-ne</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">-and</span> ($_.ReIP <span style="color:#f92672">-eq</span> <span style="color:#ae81ff">0</span>)} | <span style="color:#66d9ef">foreach</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># check machine is online</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (Test-Connection $_.MachineName -Count <span style="color:#ae81ff">1</span> -ErrorAction SilentlyContinue) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># code to set IP address - mentioned later in blog post</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">###################</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># Update counters and sleep</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">###################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># update counters</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#66d9ef">ARRAY</span>]$vmsCloneInitiated = $vmStatus | ? CloneInitiated <span style="color:#f92672">-eq</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#66d9ef">ARRAY</span>]$vmsCompleted = $vmStatus | ? {($_.Cloned <span style="color:#f92672">-ne</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">-and</span> ($_.PoweredOn <span style="color:#f92672">-ne</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">-and</span> ($_.ReIP <span style="color:#f92672">-ne</span> <span style="color:#ae81ff">0</span>)}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># sleep for $cycleTime seconds</span>
</span></span><span style="display:flex;"><span>	Start-Sleep $cycleTime
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="changing-the-ip-address-of-a-vm-once-deployed">Changing the IP address of a VM once deployed<a hidden class="anchor" aria-hidden="true" href="#changing-the-ip-address-of-a-vm-once-deployed">#</a></h2>
<p>I mentioned earlier I didn’t get along with the guest customisation method of setting the VM’s IP address. In the example above you can see where I set the IP address – one of the last things I do. I removed the code snippet for clarity in the article but here it is. Note, I also flush DNS and wait 15 seconds before continuing:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$vmStatus | where {($_.Cloned <span style="color:#f92672">-ne</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">-and</span> ($_.PoweredOn <span style="color:#f92672">-ne</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">-and</span> ($_.InAD <span style="color:#f92672">-ne</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">-and</span> ($_.ActivateWin <span style="color:#f92672">-ne</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">-and</span> ($_.ActivateOffice <span style="color:#f92672">-ne</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">-and</span> ($_.ReIP <span style="color:#f92672">-eq</span> <span style="color:#ae81ff">0</span>)} | <span style="color:#66d9ef">foreach</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># check machine is online</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (Test-Connection $_.MachineName -Count <span style="color:#ae81ff">1</span> -ErrorAction SilentlyContinue) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			Write-Host <span style="color:#e6db74">&#34;</span>$($_.MachineName)<span style="color:#e6db74">: Online, changing IP address&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e"># change IP settings</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>				Get-VM -Name $_.MachineName | Get-VMGuestNetworkInterface `
</span></span><span style="display:flex;"><span>					-Guestuser $localAdminUser `
</span></span><span style="display:flex;"><span>					-GuestPassword $localAdminPassword | `
</span></span><span style="display:flex;"><span>						? { $_.name <span style="color:#f92672">-like</span> $localNICNameQuery } | `
</span></span><span style="display:flex;"><span>							Set-VMGuestNetworkInterface `
</span></span><span style="display:flex;"><span>								-Guestuser $localAdminUser `
</span></span><span style="display:flex;"><span>								-GuestPassword $localAdminPassword `
</span></span><span style="display:flex;"><span>								-IPPolicy static `
</span></span><span style="display:flex;"><span>								-IP $_.IpAddress `
</span></span><span style="display:flex;"><span>								-Netmask $networkSubnet  `
</span></span><span style="display:flex;"><span>								-Gateway $networkGateway `
</span></span><span style="display:flex;"><span>								-DNS $networkDns
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				Write-Host <span style="color:#e6db74">&#34;</span>$($_.MachineName)<span style="color:#e6db74">: IP Address changed&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># flush dns</span>
</span></span><span style="display:flex;"><span>				ipconfig /flushdns
</span></span><span style="display:flex;"><span>                Start-Sleep <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        		<span style="color:#75715e"># update $vmStatus	</span>
</span></span><span style="display:flex;"><span>				$_.ReIP = <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">catch</span> {
</span></span><span style="display:flex;"><span>                $null
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>That’s all folks! As I mentioned previously I have published the entire script for download but hopefully the above will give you a better understanding of how this works than reading the script alone. There are a few extra features in the full script which are not explained above, such as selecting an appropriate datastore for each VM auto-magically, activating Windows and Office and starting a Windows service. You can disable these features using the $enableFeature parameters at the top of script.</p>
<p>Did you find this useful? I’d love to hear your feedback, or if you are having any issues running the script or a variant of your own leave a commend and I will do my best to help!</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/powercli/">Powercli</a></li>
      <li><a href="http://localhost:1313/tags/vmware/">Vmware</a></li>
      <li><a href="http://localhost:1313/tags/powershell/">Powershell</a></li>
      <li><a href="http://localhost:1313/tags/automation/">Automation</a></li>
      <li><a href="http://localhost:1313/tags/deployment/">Deployment</a></li>
      <li><a href="http://localhost:1313/tags/citrix/">Citrix</a></li>
      <li><a href="http://localhost:1313/tags/xenapp/">Xenapp</a></li>
      <li><a href="http://localhost:1313/tags/xendesktop/">Xendesktop</a></li>
    </ul>
  </footer><div class="comments">
  <h3>Comments</h3>
  <div class="comment-list"><div class="comment">
      <div class="comment-author">
        <img src="http://1.gravatar.com/avatar/786ed2f89de6a867d6df15412883270c?s=40&amp;d=mm&amp;r=g" alt="bvi1998" class="avatar" />
        <strong>bvi1998</strong>
        <span class="comment-date">January 21, 2014 at 9:00 pm</span>
      </div>
      <div class="comment-content"><p>Hi, Thanks for sharing the script! I am having trouble with the job calling the deployvm script, it does not seem to have the machinename or datastore at that point. Can you explain the following? - when you set the job up, where are you getting all of those arguments? - when the job is started, more parameters are sent -- haven't they already been set up when you set up the job? - the deployvm script seems to be waiting for different named parameters</p><p>Sorry it's just that I am not experienced enough in PS to understand all of this, though I have tried. Does the script run for you?</p><p>Thanks!</p></div></div></div>
</div>

<style>
.comments {
  margin-top: 2rem;
  padding-top: 2rem;
  border-top: 1px solid var(--border);
}

.comments h3 {
  margin-bottom: 1rem;
  color: var(--primary);
}

.comment {
  margin-bottom: 1.5rem;
  padding: 1rem;
  background: var(--entry);
  border-radius: 8px;
  border: 1px solid var(--border);
}

.comment-replies {
  margin-left: 2rem;
  margin-top: 1rem;
}

.comment.reply {
  background: var(--theme);
  border: 1px solid var(--border);
}

.comment-author {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

.avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
}

.comment-date {
  color: var(--secondary);
  font-size: 0.9rem;
}

.comment-content {
  line-height: 1.5;
}

.comment-content p {
  margin: 0.3rem 0;
}
</style>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Harry John</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
